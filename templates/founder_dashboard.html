<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Founder Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }

        .header {
            background-color: #333;
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            margin: 0;
        }

        .header a {
            color: white;
            text-decoration: none;
            margin-left: 1rem;
        }

        .button {
            background-color: #4CAF50;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .button:hover {
            background-color: #45a049;
        }

        .content {
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .project-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .project-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .project-card h3 {
            margin-top: 0;
            color: #333;
        }

        .project-stats {
            margin: 1rem 0;
            color: #666;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .delete-btn {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
        }

        .view-apps-btn {
            background-color: #ff9800;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
        }

        .no-projects {
            text-align: center;
            color: #666;
            margin-top: 2rem;
        }

        .applications-section {
            margin-top: 1rem;
            border-top: 1px solid #ddd;
            padding-top: 1rem;
        }

        .applications-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }

        .applications-table th,
        .applications-table td {
            padding: 0.5rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .applications-table th {
            background-color: #f5f5f5;
            font-weight: bold;
        }

        .no-applications {
            text-align: center;
            padding: 1rem;
            color: #666;
        }

        .view-apps-btn.active {
            background-color: #e67e22;
        }

        .finalize-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        .finalize-btn:hover {
            background-color: #45a049;
        }

        .project-status {
            position: absolute;
            top: 1rem;
            right: 1rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .status-active {
            background-color: #4CAF50;
            color: white;
        }

        .status-completed {
            background-color: #666;
            color: white;
        }

        .project-card.completed {
            opacity: 0.8;
        }

        .temp {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-left: 1rem;
        }
    </style>
</head>


<body>
    <div class="header">
        <h1>Welcome, {{ username }}</h1>
        <div class="temp">
            <a href="{{ url_for('create_project') }}" class="button">Add Project</a>
            <a href="{{ url_for('logout') }}">Logout</a>
        </div>
    </div>

    <div class="content">
        <h2>Your Projects</h2>
        {% if projects %}
        <div class="project-grid">
            {% for project in projects %}
            <div class="project-card {% if project[4] %}completed{% endif %}">
                <div class="project-status {% if project[4] %}status-completed{% else %}status-active{% endif %}">
                    {{ 'Completed' if project[4] else 'Active' }}
                </div>
                <h3>{{ project[1] }}</h3>
                <p>{{ project[2] }}</p>
                <div class="project-stats">
                    <p>Applications: {{ project_stats[project[0]]['total_applications'] }}</p>
                    {% if project[4] %}
                    <p>Selected Developer: {{ project_stats[project[0]]['accepted_developer'] > 0 }}</p>
                    {% endif %}
                    <p>Created: {{ project[3]|datetime }}</p>
                </div>
                <div class="action-buttons">
                    {% if not project[4] %}
                    <button onclick="toggleApplications({{ project[0] }}, this);" class="view-apps-btn">View
                        Applications</button>
                    <form action="{{ url_for('delete_project', project_id=project[0]) }}" method="POST"
                        style="display: inline;">
                        <button type="submit" class="delete-btn"
                            onclick="return confirm('Are you sure you want to delete this project?');">Delete</button>
                    </form>
                    {% else %}
                    <button onclick="toggleApplications({{ project[0] }}, this);" class="view-apps-btn">View Selected
                        Developer</button>
                    {% endif %}
                </div>
                <div id="applications-{{ project[0] }}" class="applications-section" style="display: none;">
                    <div class="applications-content">
                        <!-- Applications will be loaded here -->
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="no-projects">
            <p>You haven't created any projects yet.</p>
            <a href="{{ url_for('create_project') }}" class="button">Create Your First Project</a>
        </div>
        {% endif %}
    </div>

    <script>
        function finalizeProject(projectId, developerId, button) {
            if (confirm('Are you sure you want to finalize this project? This action cannot be undone.')) {
                fetch(`/finalize-project/${projectId}/${developerId}`, {
                    method: 'POST',
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Find the project card and update its appearance
                            const projectCard = button.closest('.project-card');

                            // Add completed class
                            projectCard.classList.add('completed');

                            // Update status indicator
                            const statusDiv = projectCard.querySelector('.project-status');
                            statusDiv.textContent = 'Completed';
                            statusDiv.classList.remove('status-active');
                            statusDiv.classList.add('status-completed');

                            // Update action buttons
                            const actionButtons = projectCard.querySelector('.action-buttons');
                            actionButtons.innerHTML = `
                            <button onclick="toggleApplications(${projectId}, this);" class="view-apps-btn">View Selected Developer</button>
                        `;

                            // Close the applications view if open
                            const applicationsDiv = document.getElementById(`applications-${projectId}`);
                            applicationsDiv.style.display = 'none';

                            // Refresh the applications view to show the selected developer
                            toggleApplications(projectId, actionButtons.querySelector('.view-apps-btn'));
                        } else {
                            alert('Failed to finalize project');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error finalizing project');
                    });
            }
        }

        function toggleApplications(projectId, button) {
            const applicationsDiv = document.getElementById(`applications-${projectId}`);
            const isHidden = applicationsDiv.style.display === 'none';

            if (isHidden) {
                // Load and show applications
                fetch(`/get-applications/${projectId}`)
                    .then(response => response.json())
                    .then(data => {
                        const content = applicationsDiv.querySelector('.applications-content');

                        if (data.applications.length > 0) {
                            let html = `
                                <table class="applications-table">
                                    <thead>
                                        <tr>
                                            <th>Developer</th>
                                            <th>Applied On</th>
                                            <th>Resume</th>
                                            ${data.is_completed ? '<th>WhatsApp</th>' : '<th>Action</th>'}
                                        </tr>
                                    </thead>
                                    <tbody>
                            `;

                            data.applications.forEach(app => {
                                const resumeLink = app.cv_link !== 'No resume provided'
                                    ? `<a href="${app.cv_link}" target="_blank">View Resume</a>`
                                    : 'No resume provided';

                                const lastColumn = data.is_completed
                                    ? `<td>${app.whatsapp_number}</td>`
                                    : `<td>
                                        <button 
                                            onclick="finalizeProject(${projectId}, ${app.developer_id}, this)"
                                            class="finalize-btn">
                                            Finalize
                                        </button>
                                       </td>`;

                                html += `
                                    <tr>
                                        <td>${app.username}</td>
                                        <td>${app.created_at}</td>
                                        <td>${resumeLink}</td>
                                        ${lastColumn}
                                    </tr>
                                `;
                            });

                            html += '</tbody></table>';
                            content.innerHTML = html;
                        } else {
                            content.innerHTML = '<div class="no-applications">No applications found.</div>';
                        }

                        applicationsDiv.style.display = 'block';
                        button.classList.add('active');
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error loading applications');
                    });
            } else {
                // Hide applications
                applicationsDiv.style.display = 'none';
                button.classList.remove('active');
            }
        }
    </script>
</body>

</html>